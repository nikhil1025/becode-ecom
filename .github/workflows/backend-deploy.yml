name: Backend CI/CD - Isolated Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ecom-backend
  CONTAINER_NAME: ecom-backend
  DEPLOY_PORT: 3001

jobs:
  deploy-backend:
    name: Deploy Backend Independently
    runs-on: ubuntu-latest

    steps:
      # =================================
      # 1. Checkout Repository
      # =================================
      - name: Checkout Code
        uses: actions/checkout@v4

      # =================================
      # 2. Setup Node.js
      # =================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      # =================================
      # 3. Install Dependencies
      # =================================
      - name: Install Dependencies
        run: |
          echo "üì¶ Installing backend dependencies..."
          npm ci

      # =================================
      # 4. Generate Prisma Client
      # =================================
      - name: Generate Prisma Client
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy?schema=public"
        run: |
          echo "üîß Generating Prisma Client..."
          npx prisma generate

      # =================================
      # 5. Build Backend
      # =================================
      - name: Build Backend Application
        run: |
          echo "üî® Building backend..."
          npm run build

      # =================================
      # 6. Create Deployment Archive
      # =================================
      - name: Create Deployment Package
        run: |
          echo "üì¶ Creating deployment archive..."
          tar -czf ../backend-deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='test' \
            --exclude='coverage' \
            --exclude='uploads' \
            --exclude='.env*' \
            --exclude='*.log' \
            .
          mv ../backend-deploy.tar.gz ./
          ls -lh backend-deploy.tar.gz

      # =================================
      # 7. Copy to EC2
      # =================================
      - name: Copy Package to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "backend-deploy.tar.gz"
          target: "/tmp/"

      # =================================
      # 8. Deploy on EC2
      # =================================
      - name: Deploy Backend on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ Starting Backend Deployment..."

            # Variables
            DEPLOY_DIR="/home/${{ secrets.EC2_USER }}/ecom-backend"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            IMAGE_NAME="${{ env.DOCKER_IMAGE }}"

            # Create deployment directory
            mkdir -p $DEPLOY_DIR

            # Extract deployment package
            echo "üì¶ Extracting package..."
            tar -xzf /tmp/backend-deploy.tar.gz -C $DEPLOY_DIR
            rm /tmp/backend-deploy.tar.gz

            # Navigate to backend folder
            cd $DEPLOY_DIR

            # =================================
            # CRITICAL: Generate .env from Secrets
            # =================================
            echo "üîê Creating .env file from GitHub Secrets..."
            cat > .env <<EOF
            DATABASE_URL=${{ secrets.DATABASE_URL }}

            JWT_SECRET=${{ secrets.JWT_SECRET }}
            ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
            JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}

            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_S3_REGION=${{ secrets.AWS_S3_REGION }}

            BREVO_SMTP_HOST=${{ secrets.BREVO_SMTP_HOST }}
            BREVO_SMTP_PORT=${{ secrets.BREVO_SMTP_PORT }}
            BREVO_SMTP_USER=${{ secrets.BREVO_SMTP_USER }}
            BREVO_SMTP_KEY=${{ secrets.BREVO_SMTP_KEY }}
            MAIL_FROM=${{ secrets.MAIL_FROM }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}

            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_CALLBACK_URL=${{ secrets.GOOGLE_CALLBACK_URL }}

            RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
            RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}

            NODE_ENV=production
            PORT=3001
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            BASE_URL=${{ secrets.BASE_URL }}
            EOF

            echo "‚úÖ .env file created successfully"

            # Backup existing container
            if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
              echo "üíæ Creating backup..."
              docker commit $CONTAINER_NAME ${IMAGE_NAME}-backup:$(date +%Y%m%d-%H%M%S) || true
            fi

            # Build new Docker image with DATABASE_URL as build arg
            echo "üî® Building Docker image..."
            docker build \
              --build-arg DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -t $IMAGE_NAME:latest .

            # =================================
            # COMPREHENSIVE MIGRATION STRATEGY
            # =================================
            echo ""
            echo "üß¨ Starting Production-Grade Migration Process..."
            echo "=================================================="

            # Step 1: Regenerate Prisma Client (also tests DB connectivity)
            echo ""
            echo "üîß Step 1/5: Regenerating Prisma Client..."
            if docker run --rm --env-file .env $IMAGE_NAME:latest npx prisma generate; then
              echo "‚úÖ Prisma Client regenerated successfully"
            else
              echo "‚ùå Failed to regenerate Prisma Client"
              exit 1
            fi

            # Step 2: Check current migration status (tests DB connectivity)
            echo ""
            echo "üìä Step 2/5: Checking current migration status..."
            docker run --rm --env-file .env $IMAGE_NAME:latest \
              npx prisma migrate status > /tmp/migrate_status.log 2>&1 || true
            cat /tmp/migrate_status.log

            # Step 3: Create logical backup of migration history
            echo ""
            echo "üíæ Step 3/5: Backing up migration history..."
            docker run --rm --env-file .env $IMAGE_NAME:latest \
              sh -c "echo 'SELECT * FROM _prisma_migrations;' | npx prisma db execute --stdin" \
              > /tmp/migration_backup.sql 2>&1 || echo "‚ö†Ô∏è  Could not backup migration history (table may not exist)"

            # Step 4: Apply migrations with intelligent error handling
            echo ""
            echo "üì¶ Step 4/5: Applying migrations..."

            if docker run --rm --env-file .env $IMAGE_NAME:latest \
              npx prisma migrate deploy 2>&1 | tee /tmp/migration_deploy.log; then
              
              echo "‚úÖ All migrations applied successfully!"
              
            else
              echo "‚ö†Ô∏è  Migration deployment encountered issues - analyzing..."
              
              # Analyze the specific error
              if grep -q "P3005" /tmp/migration_deploy.log; then
                # Schema exists but no migration history - baseline required
                echo ""
                echo "üîß Issue: Database has schema but no migration tracking (P3005)"
                echo "   Solution: Baselining existing migrations..."
                
                # List all migrations
                ALL_MIGRATIONS=$(docker run --rm --env-file .env $IMAGE_NAME:latest \
                  sh -c "ls -1 prisma/migrations | grep -E '^[0-9]' | sort")
                
                if [ -z "$ALL_MIGRATIONS" ]; then
                  echo "‚ùå No migrations found in prisma/migrations/"
                  exit 1
                fi
                
                # Baseline each migration as applied
                echo "$ALL_MIGRATIONS" | while read migration; do
                  echo "  üìù Marking as applied: $migration"
                  docker run --rm --env-file .env $IMAGE_NAME:latest \
                    npx prisma migrate resolve --applied "$migration" || true
                done
                
                # Try deploy again
                echo "  üîÑ Retrying migration deployment..."
                docker run --rm --env-file .env $IMAGE_NAME:latest \
                  npx prisma migrate deploy
                
              elif grep -q "P3006" /tmp/migration_deploy.log; then
                # Migration failed previously - needs recovery
                echo ""
                echo "üîß Issue: Previous migration failed (P3006)"
                echo "   Solution: Recovering from failed migration..."
                
                FAILED_MIGRATION=$(grep -oP '\d{14}_[a-zA-Z0-9_]+' /tmp/migration_deploy.log | head -n 1)
                
                if [ ! -z "$FAILED_MIGRATION" ]; then
                  echo "  üìù Marking as rolled back: $FAILED_MIGRATION"
                  docker run --rm --env-file .env $IMAGE_NAME:latest \
                    npx prisma migrate resolve --rolled-back "$FAILED_MIGRATION"
                  
                  echo "  üîÑ Retrying migration deployment..."
                  docker run --rm --env-file .env $IMAGE_NAME:latest \
                    npx prisma migrate deploy
                else
                  echo "  ‚ö†Ô∏è  Could not identify failed migration - attempting nuclear option..."
                  # Nuclear option: Clear migration history and rebaseline
                  echo "  üóëÔ∏è  Clearing migration history table..."
                  docker run --rm --env-file .env $IMAGE_NAME:latest \
                    sh -c "echo 'TRUNCATE TABLE _prisma_migrations;' | npx prisma db execute --stdin" \
                    || echo "‚ö†Ô∏è Could not clear table"
                  
                  echo "  üìù Rebaselining all migrations..."
                  ALL_MIGRATIONS=$(docker run --rm --env-file .env $IMAGE_NAME:latest \
                    sh -c "ls -1 prisma/migrations | grep -E '^[0-9]' | sort")
                  
                  echo "$ALL_MIGRATIONS" | while read migration; do
                    docker run --rm --env-file .env $IMAGE_NAME:latest \
                      npx prisma migrate resolve --applied "$migration" || true
                  done
                  
                  echo "  üîÑ Deploying any new migrations..."
                  docker run --rm --env-file .env $IMAGE_NAME:latest \
                    npx prisma migrate deploy || true
                fi
                
              elif grep -q "P3009" /tmp/migration_deploy.log; then
                # Migration files were edited after being applied
                echo ""
                echo "üîß Issue: Migration files were modified (P3009)"
                echo "   Solution: This requires manual intervention"
                echo "   The migration history doesn't match the migration files"
                cat /tmp/migration_deploy.log
                echo ""
                echo "‚ö†Ô∏è  Continuing anyway - review logs above"
                
              elif grep -q "P2021\|relation.*does not exist" /tmp/migration_deploy.log; then
                # Fresh database - no tables at all
                echo ""
                echo "üîß Issue: Fresh database detected (P2021)"
                echo "   Solution: Applying all migrations from scratch..."
                
                docker run --rm --env-file .env $IMAGE_NAME:latest \
                  npx prisma migrate deploy --skip-seed
                
              elif grep -q "P1017" /tmp/migration_deploy.log; then
                # Server closed connection - transient error
                echo ""
                echo "üîß Issue: Database connection lost (P1017)"
                echo "   Solution: Retrying migration..."
                sleep 5
                
                docker run --rm --env-file .env $IMAGE_NAME:latest \
                  npx prisma migrate deploy
                
              else
                # Unhandled error - use nuclear option
                echo ""
                echo "‚ö†Ô∏è  UNHANDLED ERROR - Attempting recovery..."
                echo "   This is the nuclear option: clear migration history and rebaseline"
                cat /tmp/migration_deploy.log
                
                echo ""
                echo "  üóëÔ∏è  Step 1: Backing up migration history..."
                docker run --rm --env-file .env $IMAGE_NAME:latest \
                  sh -c "echo 'CREATE TABLE IF NOT EXISTS _prisma_migrations_backup AS SELECT * FROM _prisma_migrations;' | npx prisma db execute --stdin" \
                  || echo "‚ö†Ô∏è Could not backup"
                
                echo "  üóëÔ∏è  Step 2: Clearing migration history..."
                docker run --rm --env-file .env $IMAGE_NAME:latest \
                  sh -c "echo 'TRUNCATE TABLE _prisma_migrations;' | npx prisma db execute --stdin" \
                  || echo "‚ö†Ô∏è Could not clear"
                
                echo "  üìù Step 3: Baselining all migrations..."
                ALL_MIGRATIONS=$(docker run --rm --env-file .env $IMAGE_NAME:latest \
                  sh -c "ls -1 prisma/migrations | grep -E '^[0-9]' | sort")
                
                if [ ! -z "$ALL_MIGRATIONS" ]; then
                  echo "$ALL_MIGRATIONS" | while read migration; do
                    echo "      - $migration"
                    docker run --rm --env-file .env $IMAGE_NAME:latest \
                      npx prisma migrate resolve --applied "$migration" 2>&1 | grep -v "^Prisma schema loaded" || true
                  done
                fi
                
                echo "  üîÑ Step 4: Deploying any new migrations..."
                docker run --rm --env-file .env $IMAGE_NAME:latest \
                  npx prisma migrate deploy || echo "    ‚ö†Ô∏è  No new migrations to apply"
                
                echo "  ‚úÖ Recovery complete - migration history reset and rebaselined"
              fi
            fi

            # Step 5: Final verification
            echo ""
            echo "üìä Step 5/5: Final migration status verification..."
            docker run --rm --env-file .env $IMAGE_NAME:latest \
              npx prisma migrate status || true

            echo ""
            echo "‚úÖ Migration process complete!"
            echo "=================================================="
            echo ""

            docker rm -f $CONTAINER_NAME || true
            sleep 2

            # Create uploads volume
            docker volume create ecom-backend-uploads || true

            # Run new container
            echo "üö¢ Starting new container..."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p ${{ env.DEPLOY_PORT }}:3001 \
              --env-file .env \
              -v ecom-backend-uploads:/app/uploads \
              $IMAGE_NAME:latest

            # Wait for container
            echo "‚è≥ Waiting for container to start..."
            sleep 20

            # Check container status
            if [ "$(docker ps -q -f name=$CONTAINER_NAME -f status=running)" ]; then
              echo "‚úÖ Backend deployment successful!"
              echo ""
              echo "üìã Container logs:"
              docker logs --tail 50 $CONTAINER_NAME
            else
              echo "‚ùå Backend deployment failed!"
              echo ""
              echo "üìã Container logs:"
              docker logs --tail 100 $CONTAINER_NAME

              docker rm -f $CONTAINER_NAME || true
              
              # Attempt rollback
              BACKUP_IMAGE=$(docker images -q ${IMAGE_NAME}-backup --format "{{.Repository}}:{{.Tag}}" | head -n 1)
              if [ ! -z "$BACKUP_IMAGE" ]; then
                echo "üîÑ Rolling back to backup..."
                docker run -d \
                  --name $CONTAINER_NAME \
                  --restart unless-stopped \
                  -p ${{ env.DEPLOY_PORT }}:3001 \
                  --env-file .env \
                  -v ecom-backend-uploads:/app/uploads \
                  $BACKUP_IMAGE
              fi
              
              exit 1
            fi

            # Cleanup old images
            echo "üßπ Cleaning up old images..."
            docker images ${IMAGE_NAME} --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true

            echo "‚ú® Backend deployment complete!"

      # =================================
      # 9. Verify Deployment
      # =================================
      - name: Verify Backend Health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üîç Verifying backend deployment..."
            docker ps -f name=${{ env.CONTAINER_NAME }} --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "üìã Recent logs:"
            docker logs --tail 30 ${{ env.CONTAINER_NAME }}
            echo ""
            echo "üè• Health check:"
            sleep 5
            curl -f http://localhost:${{ env.DEPLOY_PORT }}/api/health || echo "‚ö†Ô∏è Health endpoint not responding"

      # =================================
      # 10. Notify on Failure
      # =================================
      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Backend deployment failed!"
          echo "Check the logs above for details."
          exit 1
